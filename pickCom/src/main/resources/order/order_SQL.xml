<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="order">

    <!-- 주문페이지에 필요한 회원정보 검색 -->
    <select id="orderMemberInfo" parameterType="hashmap" resultType="hashmap">
		<![CDATA[
        SELECT
            MEMBER_ID,
            MEMBER_NAME,
            MEMBER_NICKNAME,
            MEMBER_PASSWD,
            MEMBER_EMAIL,
            MEMBER_RANK,
            TO_CHAR(MEMBER_REGDATE,, 'YYYY/MM/DD') MEMBER_REGDATE,
            TO_CHAR(MEMBER_LASTDATE,, 'YYYY/MM/DD') MEMBER_LASTDATE,
            MEMBER_DELETE,
            MEMBER_VISITCOUNT
        FROM
            MEMBER
        WHERE
            MEMBER_NUM = #{MEMBER_NUM}
        ]]>
	</select>

    <!-- 주문추가 -->
    <insert id="insertOrder" parameterType="hashmap">
        <![CDATA[
			INSERT INTO ORDERS
			(
				MEMBER_NUM,
			    ORDER_ADDRESS
			)
			VALUES
			(
				#{MEMBER_NUM},
				0
			)
		]]>
    </insert>

    <!-- 주문상세 추가 -->
    <insert id="insertOrderDetail" parameterType="hashmap">
        <!-- ORDERLIST의 ORDER_NO찾기 -->
        <selectKey keyProperty="ORDER_NO" resultType="int" order="BEFORE">
            SELECT DISTINCT
            ORDER_NO
            FROM
            ORDER_LIST
            WHERE
            MEMBER_NO = #{MEMBER_NO}
            AND ORDER_NO = (SELECT MAX(ORDER_NO) FROM ORDER_LIST)
        </selectKey>
        <![CDATA[
			INSERT INTO ORDER_DETAIL
			(
				ORDER_DETAIL_NO,
			    ORDER_NO,
			    GOODS_NO,
			    GOODS_ATT_NO,
			    ORDER_DETAIL_PRICE,
			    ORDER_DETAIL_COLOR,
			    ORDER_DETAIL_SIZE,
			    ORDER_DETAIL_AMOUNT,
			    COUPON_NO,
			    COUPON_DISCOUNT,
			    ORDER_DISCOUNT_APPLY,
			    ORDER_DETAIL_STATE
			)
			VALUES
				(ORDER_DETAIL_NO_SEQ.NEXTVAL,
				#{ORDER_NO},
				#{GOODS_NO},
				#{GOODS_ATT_NO},
				#{ORDER_DETAIL_PRICE},
				#{ORDER_DETAIL_COLOR},
				#{ORDER_DETAIL_SIZE},
				#{ORDER_DETAIL_AMOUNT},
				#{COUPON_NO},
				#{COUPON_DISCOUNT},
				#{ORDER_DISCOUNT_APPLY},
				0)
		]]>
    </insert>

    <!-- 주문완료 페이지에 뿌려줄 ORDER_NO -->
    <select id="selectOrder" parameterType="hashmap" resultType="hashmap">
		<![CDATA[
        SELECT
            MAX(ORDER_NO) ORDER_NO
        FROM
            ORDER_LIST
        WHERE
            MEMBER_NO = #{MEMBER_NO}
        ]]>
	</select>

    <!-- 주문 배송정보 수정 -->
    <update id="orderModify" parameterType="hashmap">
		<![CDATA[
        UPDATE ORDER_LIST
        SET
            ORDER_NAME = #{ORDER_NAME},
            ORDER_PHONE = #{ORDER_PHONE},
            ORDER_ZIPCODE = #{ORDER_ZIPCODE},
            ORDER_ADDR1 = #{ORDER_ADDR1},
            ORDER_ADDR2 = #{ORDER_ADDR2}
        WHERE
            ORDER_NO = #{ORDER_NO}
        ]]>
	</update>


</mapper>